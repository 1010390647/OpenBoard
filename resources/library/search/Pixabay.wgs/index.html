<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/> 
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>Pixabay Image Search</title>
        <link rel="stylesheet" type="text/css" href="css/basic.css"/>
        <script type="text/javascript" src="scripts/jquery-1.6.2.min.js"></script>
    </head>

    <body>
    </body>

    <script type="text/javascript">
        /* 
           This script makes use of the Pixabay image search API, documented here:
           https://pixabay.com/api/docs/
        */

        var API_KEY = '2217022-41b455b44dccd972675602446'; // TODO: move this to C++


        // Number of results per page
        var limit = 10; 

        // Maximum number of pages to display
        var maxPages = 10;

        // Minimum size of pictures to search for
        var minHeight = 150;
        var minWidth = 150;

        // Image type to retrieve. Can be "photo", "illustration", "vector" or "all".
        var imageType = "all"

        // Language code to search in
        var searchLanguage = "en"
        



        // ---------------------
        // Globals
        var currentIndex = 0;
        var currentTerm = "";
        // ---------------------

        $(document).ready(loadPage)

        function loadPage() {
            //variables
            var mode = false; //search or view mode
            var hide = false; //hide or no main panel

            //basic containers and elements    
            
            var search = $("<div id='search' class='search'>").appendTo("body");

            var subSearchInput = $("<div id='subSearchInput' class='subSearch'>").appendTo(search);
            var subSearchFilter = $("<div id='subSearchFilter' class='subSearch'>").appendTo(search);

            var searchInput = $("<input id='searchInput' class='searchInput' type='text'/>").appendTo(subSearchInput);
            var searchButton = $("<div id='searchButton' class='searchButton'>").appendTo(subSearchInput);

            var searchResult = $("<div id='searchResult'>").appendTo("body");

            var disc_nav_cont = $("<div id='disc_nav_cont' class='disc_nav_cont'>").appendTo("body");    
            var disclaimer = $("<div id='disclaimer' class='disclaimer'>Pixabay.com image search<div>").appendTo(disc_nav_cont);

                        
            searchButton.click(function(){
                if(!hide){
                    runSearch(searchInput.val(), 0);
                }
            });
            
            searchInput.keydown(function(event){
                if(!hide){
                    if((event.keyCode == 0xA)||(event.keyCode == 0xD)){
                        runSearch(searchInput.val(), 0);
                    }
                          
                }
            });
            (
            $(".imgContainer").live("click",function(){
                sankore.sendFileMetadata(createMetaData($(this)));
            }));
            
        }

        function runSearch(term, index) {
            currentTerm = term;
            currentIndex = index;
            var page = index+1; // Page numbers start at 1 on Pixabay
            var url = "https://pixabay.com/api/?key="+API_KEY
                        +"&q="+escape(term)
                        +"&per_page="+limit
                        +"&page="+page
                        +"&min_width="+minWidth
                        +"&minHeight="+minHeight
                        +"&image_type="+imageType
                        +"&lang="+searchLanguage
                        +"&safesearch=true";

            //console.log(url);

            $.ajax({
                url: url,
                success: searchComplete,
                error: searchFail,
                dataType: "json"
            });
        }

        function searchComplete(json) {
            // Grab our content div, clear it.
            var totalResults = json.totalHits;
            var contentDiv = $('#searchResult').empty();
            // Loop through our results, printing them to the page.
            var results = json.hits;

            //TODO: display a message on page when there are zero results. Would require locales, ideally

            for (var i = 0; i < results.length; i++) {
                var result = results[i];

                /* 
                   Images are displayed in an `imgContainer` element. It contains
                   the image itself (`newImg`) but also some hidden fields containing
                   metadata that is sent to OpenBoard if the user clicks the image
                */

                // Image element
                var imgContainer = $("<div class='imgContainer' draggable='true'>");
                var newImg = document.createElement('img');

                newImg.src = result.previewURL;

                var imgWidth = (result.tbWidth > minWidth)?result.tbWidth:minWidth;
                var imgHeight = (result.tbHeight > minHeight)?result.tbHeight:minHeight;
                imgContainer.width(imgWidth).height(imgHeight);
                imgContainer.append($(newImg));

                // Metadata to send to OpenBoard
                var iUrl = $("<input type='hidden'/>");
                var iContent = $("<input type='hidden'/>");
                var iHeight = $("<input type='hidden'/>");
                var iWidth = $("<input type='hidden'/>");
                var iThumbnailUrl = $("<input type='hidden'/>");
                var iTitle = $("<input type='hidden'/>");

                iUrl.attr("value", result.webformatURL);
                iContent.attr("value", result.type);
                iHeight.attr("value", result.webformatHeight);
                iWidth.attr("value", result.webformatWidth);
                iThumbnailUrl.attr("value", result.previewURL);
                iTitle.attr("value", getImageTitle(result));

                imgContainer.append(iUrl);
                imgContainer.append(iContent);
                imgContainer.append(iHeight);
                imgContainer.append(iWidth);
                imgContainer.append(iThumbnailUrl);
                imgContainer.append(iTitle);

                // Add the image to the page
                imgContainer.appendTo(contentDiv);

            }
            // Now add links to additional pages of search results.
            addPaginationLinks(totalResults);
        }



        function addPaginationLinks(totalResults) {
            var curPage = currentIndex; 
            var pagesDiv = $("<div id='resultFooter' class='resultFooter'>");

            var highestPageNumber = maxPages;
            if (totalResults/limit < maxPages)
                highestPageNumber = totalResults/limit;

            for (var i = 0; i < highestPageNumber; i++) {
                var link = $("<a class='pager_button'></a>").attr('href', 'javascript:gotoPage('+i+');').html(i+1).appendTo(pagesDiv);
                if (curPage == i) 
                    link.addClass('active');
            }

            $("#disc_nav_cont #resultFooter").remove();
            pagesDiv.insertBefore($('#disclaimer'));
            
            $(".imgContainer").each(function(){
                this.addEventListener("dragstart", imageDragging, false);
            })
            
            $(".imgContainer").each(function(){
                this.addEventListener("dragenter", imageDragenter, false);
            })
            
            $(".imgContainer").each(function(){
                this.addEventListener("dragleave", imageDragleave, false);
            })
            
            $(".imgContainer").each(function(){
                this.addEventListener("dragover", imageDragover, false);
            })
        }

        function searchFail(jqXHR, textStatus, errorThrown) {
            alert('Couldn\'t connect to Pixabay: ' + textStatus + ' ' + errorThrown);
        }

         function imageDragging(e){
            e.dataTransfer.setData("text/plain",$(this).find("input:hidden").eq(0).val());
        }
        
        function imageDragleave(e){
            return false;
        }
        
        function imageDragover(e){
            return false;
        }
        
        function imageDragenter(e){
            return false;
        }
       
        function gotoPage(i) { 
            runSearch(currentTerm, i);             
        } 

        function createMetaData(parent){
            var meta = "";
            //alert($(this).find("input:hidden").eq(0).val());
            meta = "<metadata><data><key>Type</key><value>Image</value></data><data><key>Url</key><value>" + 
                parent.find("input:hidden").eq(0).val() + 
                "</value></data><data><key>Content</key><value>" + 
                parent.find("input:hidden").eq(1).val() +
                "</value></data><data><key>Height</key><value>" + 
                parent.find("input:hidden").eq(2).val() +
                "</value></data><data><key>Width</key><value>" +
                parent.find("input:hidden").eq(3).val() +
                "</value></data><data><key>thumbnailUrl</key><value>" +
                parent.find("input:hidden").eq(4).val() +
                "</value></data><data><key>Title</key><value>" +
                parent.find("input:hidden").eq(5).val() +
                "</value></data></metadata>";
            return meta;
        }
        
        function getImageTitle(image) {
            // Pixabay images don't have a title, but we can fetch the first tag and use that as a title.

            var firstTag = image.tags.split(",")[0]
            //console.log(firstTag);
            return firstTag;
        }


    </script>

</html>
